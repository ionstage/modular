!function(e){"use strict";function t(e,t){if("function"==typeof e){var n,r,o=null;return function(){n=this,r=arguments,null!==o&&clearTimeout(o),o=setTimeout(function(){e.apply(n,r)},t)}}}function n(){if(!i.support.svg)return void alert("Sorry, your browser doesn't support this application.");var e=a.getElement();d.element({sidePanel:e.sidePanel,divider:e.divider,dividerIcon:e.dividerIcon,mainPanel:e.mainPanel});var n=l.load("side-view-state")||"open";d[n](),d.on("change",function(e){l.save("side-view-state",e.state),C.size(y.size()),y.resetTouchScroll()}),p.element(e.searchInput),p.on("input",t(d.updatePieceListView,1e3/60)),u.element({pieceListItemTemplate:e.pieceListItemTemplate,pieceTemplate:e.pieceTemplate,portTemplate:e.portTemplate}),f.element(e.pieceList),f.on("dragend",function(e){var t=y.pageToLocal({x:e.pageX,y:e.pageY});if(t.x>=0&&t.y>=0){var n=b.create(e.pieceSrc);n.label(e.pieceLabel),n.position(t),n.updatePosition(),y.append(n),v.add({src:e.pieceSrc}),d.updatePieceListView()}}),h.load(l.load("piece-lists"),function(){v.update(),d.updatePieceListView()}),m.element({button:e.pieceListManagerButton}),g.element({mainPanel:e.mainPanel}),C.element(e.pathContainer),y.element({mainPanel:e.mainPanel,board:e.board}),x.element({mainPanel:e.mainPanel,board:e.board}),x.loadURLHash()}var r=require("js-base64").Base64,o=e.document,i=e.lib,a=function(){function e(){for(var e={},t=o.querySelectorAll("[id]"),n=0,r=t.length;r>n;n+=1){var a=t[n];e[i.util.camelCase(a.id,"_")]=a}return e}function t(e,t){e.addEventListener(f,function(e){n(e,t)},!1)}function n(e,t){function n(e){e.preventDefault(),e.stopPropagation(),e=p?e.touches[0]:e;var a=Math.abs(e.pageX-o.left),c=Math.abs(e.pageY-o.top);(a>5||c>5)&&(i.removeEventListener(h,n,!1),i.removeEventListener(v,r,!1),"function"==typeof t.cancel&&s(t.cancel))}function r(e){e.preventDefault(),e.stopPropagation(),i.removeEventListener(h,n,!1),i.removeEventListener(v,r,!1),"function"==typeof t.tap&&s(t.tap)}var o,i=e.currentTarget;e.preventDefault(),e.stopPropagation(),e=p?e.touches[0]:e,o={left:e.pageX,top:e.pageY},i.addEventListener(h,n,!1),i.addEventListener(v,r,!1)}function r(e,t){function n(e){e.preventDefault(),e.stopPropagation(),e=p?e.touches[0]:e;var n=e.pageX-i.left,r=e.pageY-i.top;"function"==typeof t.drag&&t.drag(n,r)}function r(e){if(e.preventDefault(),e.stopPropagation(),!(p&&e.touches.length>0)){e=p?e.changedTouches[0]:e,o.removeEventListener(h,n,!1),o.removeEventListener(v,r,!1);var a=e.pageX-i.left,c=e.pageY-i.top;"function"==typeof t.end&&t.end(a,c)}}var i;e.preventDefault(),e.stopPropagation(),e=p?e.touches[0]:e,i={left:e.pageX,top:e.pageY},o.addEventListener(h,n,!1),o.addEventListener(v,r,!1)}function a(e,t){var n=e.className;return-1!==(n+" ").indexOf(t+" ")}function c(e,t){var n=e.className;-1===(" "+n).indexOf(" "+t)&&(e.className=(n+" "+t).trim())}function l(e,t){"undefined"==typeof t&&(e.className=""),a(e,t)&&(e.className=(e.className+" ").replace(t+" ","").trim())}function u(e){var t="";for(var n in e)t=t+n+":"+e[n]+";";return t}function d(e,t){for(var n=e.children,r=0,o=n.length;o>r;r+=1)if(n[r]===t)return r;return-1}var p=i.support.touch,f=p?"touchstart":"mousedown",h=p?"touchmove":"mousemove",v=p?"touchend":"mouseup";return{getElement:e,setTapEvent:t,startTapEvent:n,startDragEvent:r,eventType:{START:f,MOVE:h,END:v},hasClass:a,addClass:c,removeClass:l,makeCSSText:u,indexOf:d}}(),c=function(){function e(e){n.cursor=e}function t(e){var t=this;e.addEventListener("mouseover",function(e){t.type("pointer")},!1),e.addEventListener("mouseout",function(e){t.type("default")},!1)}var n=o.body.style;return{type:e,setMouseHoverEffect:t}}(),s=function(){return e.requestAnimationFrame||e.webkitRequestAnimationFrame||e.mozRequestAnimationFrame||function(t){e.setTimeout(t,1e3/60)}}(),l=function(){function e(e){return r.get(n+"."+e)}function t(e,t){r.set(n+"."+e,t)}var n="org.ionstage.board",r=i.storage;return{load:e,save:t}}(),u=function(){function e(e){var t=o.createElement("div");return t.innerHTML=e.replace(/\r\n/g,"").trim(),t.firstChild}function t(t){c=t,s=e(c.pieceListItemTemplate.innerHTML),l=e(c.pieceTemplate.innerHTML),u=e(c.portTemplate.innerHTML)}function n(e,t,n){var r=s.cloneNode(!0),o={element:r,container:r.children[0],containerHeader:r.children[0].children[0],containerContent:r.children[0].children[1]};return o.container.setAttribute("data-piece-src",n),o.containerHeader.textContent=e||"",o.containerContent.textContent=t||"",o}function r(e){var t=l.cloneNode(!0),n={element:t,header:t.children[0],headerTitle:t.children[0].children[0],headerDeleteButton:t.children[0].children[1],content:t.children[1],componentBack:t.children[1].children[0],component:t.children[1].children[1],portList:t.children[1].children[2],footer:t.children[2],portSelect:t.children[2].children[0],portSelectOptionGroup:{prop:t.children[2].children[0].children[1],event:t.children[2].children[0].children[2]}};return n.component.setAttribute("src",e),n}function i(e,t,n,r){var o=u.cloneNode(!0);a.addClass(o,e);var i={element:o,connector:o.children[0],connectorIn:o.children[0].children[0],connectorConnected:o.children[0].children[1],connectorOut:o.children[0].children[2],content:o.children[1],contentText:o.children[1].children[0],contentDeleteButton:o.children[1].children[1]};return i.contentText.textContent=t,n||a.addClass(i.connectorIn,"hide"),r||a.addClass(i.connectorOut,"hide"),i}var c=null,s=null,l=null,u=null;return{element:t,createPieceListItem:n,createPiece:r,createPort:i}}(),d=function(){function e(e){var t=this;l=e;var n=l.divider;c.setMouseHoverEffect(n),n.addEventListener(a.eventType.START,function(e){a.startTapEvent(e,{tap:function(){t.toggle(),c.type("default"),u&&m(n,"tap")},cancel:function(){u&&m(n,"tap")}}),u&&d(n,"tap")},!1)}function t(){s="open",l.dividerIcon.textContent="<",l.sidePanel.className="",this.trigger({type:"change",state:s})}function n(){s="close",l.dividerIcon.textContent=">",l.sidePanel.className="close",this.trigger({type:"change",state:s})}function r(){switch(s){case"open":this.close();break;case"close":this.open()}}function o(){var e,t=p.inputValue();if(0!==t.length){if(g===t)return;e=h.search(t).toListViewItems(),f.updateSearchedListItems(e)}else e=v.listViewItems(),f.updateRecentryUsedListItems(e);g=t}var s=null,l=null,u=i.support.touch,d=a.addClass,m=a.removeClass,g=null;return i.event.enable({element:e,open:t,close:n,toggle:r,updatePieceListView:o})}(),p=function(){function e(e){return e.x<280&&e.y<46}function t(t){function n(e){var t=e.target.value;a!==t&&(p.trigger({type:"input"}),a=t)}r=t,c?(r.className="touch",o.addEventListener("touchstart",function(t){e({x:t.pageX,y:t.pageY})||r.blur()},!1)):(r.addEventListener("blur",function(){s=!1},!1),r.addEventListener("click",function(){s||r.selectionStart!==r.selectionEnd||(r.select(),s=!0)},!1)),r.value=a,r.addEventListener("keyup",n,!1),r.addEventListener("input",n,!1)}function n(){return r.value}var r=null,a="",c=i.support.touch,s=!1;return i.event.enable({element:t,inputValue:n})}(),f=function(){function e(){var e=".piece-list-item-container:hover {opacity: 0.6;}",t=o.createElement("style");t.appendChild(o.createTextNode(e)),o.getElementsByTagName("head")[0].appendChild(t)}function t(t){l=t,v(l),h||e()}function n(e){p=e}function r(e){var t=p,n=o.createElement("div"),r=l.children[0];n.id="piece_list_content";var i=e?'<div id="piece_list_title">Recentry Used</div>':"";h?r.innerHTML=i:n.innerHTML=i;for(var a=0,c=t.length;c>a;a+=1){var s=t[a],d=u.createPieceListItem(s.title,s.content,s.pieceSrc);h?r.appendChild(d.element):n.appendChild(d.element)}h||l.replaceChild(n,r)}function c(e){this.listItems(e),this.update()}function s(e){this.listItems(e),this.update(!0)}var l=null,p=null,h=i.support.touch,v=function(){var e=h?"touchstart":"mousedown",t=h?"touchmove":"mousemove",n=h?"touchend":"mouseup";return function(r,i){function c(e){var t=e.target.parentNode;if("piece-list-item-container"===t.className){m=t.cloneNode(!0);var n=r.children[0];g={left:t.offsetLeft-n.scrollLeft,top:t.offsetTop-n.scrollTop},t.style.cssText=a.makeCSSText({opacity:.6}),C=t,a.addClass(m,"drag"),o.body.appendChild(m),o.activeElement&&o.activeElement.blur&&o.activeElement.blur(),x=!0,b=!1,a.startDragEvent(e,{drag:s,end:l})}}function s(e,t){x&&(x=!1,y.clientWidth()<46&&(b=!0,d.close()));var n=a.makeCSSText({left:g.left+e+"px",top:g.top+t+"px"});m.style.cssText=n}function l(e,t){if(C.style.cssText="",o.body.removeChild(m),0!==e||0!==t){var n=g.left+e,r=g.top+t,i={type:"dragend",pageX:n,pageY:r,pieceSrc:m.getAttribute("data-piece-src"),pieceLabel:m.children[0].textContent};f.trigger(i)}b&&d.open()}function u(e){L=!1,null!==T&&clearTimeout(T),o.removeEventListener(t,p,!1),o.removeEventListener(n,v,!1)}function p(e){e=h?e.touches[0]:e;var t=Math.abs(e.pageX-P.left),n=Math.abs(e.pageY-P.top);(t>5||n>5)&&u()}function v(e){u()}var m,g,C,x,b;if(h){var P,L=!0,T=null;r.addEventListener(e,function(e){L=!0;var r=e.touches[0];P={left:r.pageX,top:r.pageY},null!==T&&clearTimeout(T),T=setTimeout(function(){T=null,L&&(o.removeEventListener(t,p,!1),o.removeEventListener(n,v,!1),c(e))},300),o.addEventListener(t,p,!1),o.addEventListener(n,v,!1)},!1)}else r.addEventListener(e,c,!1)}}();return i.event.enable({element:t,listItems:n,update:r,updateSearchedListItems:c,updateRecentryUsedListItems:s})}(),h=function(){function e(){return u}function t(){for(var e=[],t=0,n=this.length;n>t;t+=1){var r=this[t];e.push({title:r.label,content:r.description,pieceSrc:r.src})}return e}function n(e,t){for(var n=0,r=e.length;r>n;n+=1)if(-1!==e[n].toLowerCase().indexOf(t))return!0;return!1}function r(e){if(0===e.length)return{length:0,toListViewItems:t};var r=u,o=[],i=[],a=[],c=[];e=e.toLowerCase();for(var s=0,l=r.length;l>s;s+=1){var d=r[s];0===d.label.toLowerCase().indexOf(e)?o.push(d):n(d.tag,e)?a.push(d):e.length>=2&&-1!==d.label.toLowerCase().indexOf(e)?i.push(d):e.length>=2&&-1!==d.description.toLowerCase().indexOf(e)&&c.push(d)}var p=o.concat(a,i,c);return p.toListViewItems=t,p}function i(e,t){function n(e){o.body.removeChild(r),"function"==typeof t&&t(e)}var r=o.createElement("iframe");r.style.cssText=a.makeCSSText({position:"absolute",visibility:"hidden",width:"1px",height:"1px"}),r.setAttribute("name",""),r.setAttribute("src",e),r.onload=function(){var e=0;setTimeout(function t(){var o="";try{o=r.contentWindow.name}catch(i){}return""!==o?void n(o):void(30>e?(e+=1,setTimeout(t,100)):n(null))},100)},o.body.appendChild(r)}function c(){for(var e=u,t=[],n={},r=0,o=e.length;o>r;r+=1){var i=e[r];"undefined"==typeof n[i.src]&&(t.push(i),n[i.src]=!0)}t.sort(function(e,t){return e.label>t.label?1:-1}),u=t}function s(e,t){function n(t){var n=e[t];-1===d.indexOf(n)?i(n,function(e){if(null===e)return void r(t);try{u=u.concat(JSON.parse(e))}catch(o){return void r(t)}d.push(n),r(t)}):r(t)}function r(e){e+=1,o>e?n(e):(c(),t())}var o=e.length;n(0)}function l(){u=[],d=[]}var u=[],d=[];return{list:e,search:r,load:s,clear:l}}(),v=function(){function e(e,t){return o(e)&&o(t)?e.src===t.src:!1}function t(){for(var t=c,n=h.list(),r=[],o=0,i=t.length;i>o;o+=1)for(var a=n.length-1;a>=0;a-=1)if(e(t[o],n[a])){var s=n[a];r.push({title:s.label,content:s.description,pieceSrc:s.src})}return r}function n(){for(var t=c,n=h.list(),r=[],o=0,i=t.length;i>o;o+=1)for(var s=n.length-1;s>=0;s-=1)e(t[o],n[s])&&r.push(t[o]);c=r,l.save(a,c)}function r(t){for(var n=c,r=n.length-1;r>=0;r-=1)e(n[r],t)&&n.splice(r,1);c.unshift(t),c.splice(s),this.update()}var o=i.util.isObject,a="recentry-used",c=l.load(a);null===c&&(c=[]);var s=20;return{listViewItems:t,update:n,add:r}}(),m=function(){function t(t){var r=t.button;r.addEventListener("click",function(){var t=Math.floor(Math.random()*Math.pow(10,16)).toString(),r=e.open("piecelist/manager.html",CryptoJS.SHA1(t).toString(),"height=380,width=380,menubar=no,toolbar=no,location=no,status=no");r&&setTimeout(function o(){r.closed?(h.clear(),h.load(l.load(n),function(){v.update(),d.updatePieceListView()})):setTimeout(o,1e3)},1e3)})}var n="piece-lists",r=l.load(n);return null===r&&(r=["piecelist/default.html"],l.save(n,r)),{element:t}}(),g=function(){function e(){var e=o.createElement("div");return e.className="port-connector-out drag hide",e}function t(e){u=e.mainPanel,u.appendChild(l)}function n(){a.removeClass(l,"hide")}function r(){a.addClass(l,"hide")}function i(){var e=a.makeCSSText({left:this._x+"px",top:this._y+"px"});l.style.cssText=e}function c(e){return e?("x"in e&&(this._x=e.x),void("y"in e&&(this._y=e.y))):{x:this._x,y:this._y}}function s(e){d&&a.removeClass(l,d),a.addClass(l,e),d=e}var l=e(),u=null,d=null;return{element:t,show:n,hide:r,update:i,position:c,type:s}}(),C=function(){function e(){return o.createElementNS("http://www.w3.org/2000/svg","path")}function t(e){h=e}function n(t,n){var r=h.querySelector('[data-source-id="'+t+'"][data-target-id="'+n+'"]');r||(r=e(),r.setAttribute("data-source-id",t),r.setAttribute("data-target-id",n),h.appendChild(r))}function r(e,t){var n=h.querySelector('[data-source-id="'+e+'"][data-target-id="'+t+'"]');n&&h.removeChild(n)}function i(e,t){if(e[0]!==t[0]||e[1]!==t[1]){var n=h.querySelector('[data-source-id="'+e[0]+'"][data-target-id="'+e[1]+'"]');if(n){var r=h.querySelector('[data-source-id="'+t[0]+'"][data-target-id="'+t[1]+'"]');r&&this.remove(t[0],t[1]),n.setAttribute("data-source-id",t[0]),n.setAttribute("data-target-id",t[1])}}}function a(e,t){v.push(e),m[e]=t}function c(){for(var e=0,t=v.length;t>e;e+=1)for(var n=v[e],r=h.querySelectorAll('[data-source-id="'+n+'"],[data-target-id="'+n+'"]'),o=0,i=r.length;i>o;o+=1){var a=r[o],c=a.getAttribute("data-source-id"),s=a.getAttribute("data-target-id"),l=m[c],u=m[s];a.setAttribute("d","M"+l.x+","+l.y+"L"+u.x+","+u.y+"Z")}v=[]}function s(){for(var e in m){var t=h.querySelectorAll('[data-source-id="'+e+'"],[data-target-id="'+e+'"]');0===t.length&&delete m[e]}}function l(e){"width"in e&&(h.style.width=e.width+"px"),"height"in e&&(h.style.height=e.height+"px")}function u(e){var t=h.querySelector('[data-target-id="'+e+'"]');return t?t.getAttribute("data-source-id"):null}function d(e){for(var t=[],n=h.querySelectorAll('[data-source-id="'+e+'"]'),r=0,o=n.length;o>r;r+=1)t.push(n[r].getAttribute("data-target-id"));return t}function p(e,t,n){var r=h.querySelector('[data-source-id="'+e+'"][data-target-id="'+t+'"]');r&&(n?r.setAttribute("class","flush"):r.removeAttribute("class"))}function f(){for(var e=[],t=h.childNodes,n=0,r=t.length;r>n;n+=1){var o=t[n];e.push({sourceID:o.getAttribute("data-source-id"),targetID:o.getAttribute("data-target-id")})}return e}var h=null,v=[],m={};return{element:t,append:n,remove:r,change:i,position:a,updatePosition:c,refreshPosition:s,size:l,getSourceID:u,getTargetIDs:d,setFlushPath:p,getConnectionList:f}}(),y=function(){function e(e){P=e.mainPanel,L=e.board}function t(e){return{x:e.x-P.offsetLeft+P.scrollLeft,y:e.y+P.scrollTop}}function n(e){var t=M();e.id(t),T[t]=e,L.appendChild(e.element())}function r(e){e.destroy(),L.removeChild(e.element());var t=e.id();delete T[t]}function c(){return T}function s(){for(var e in T)T[e].showComponentBack()}function l(){for(var e in T)T[e].hideComponentBack()}function u(){var e=T,t=0,n=0;for(var r in e){var o=e[r].element(),i=o.offsetLeft+o.offsetWidth;i>t&&(t=i);var a=o.offsetTop+o.offsetHeight;a>n&&(n=a)}return t=Math.max(P.clientWidth,t+45),n=Math.max(P.clientHeight,n+3),{width:t,height:n}}function d(e){for(var t=P.querySelectorAll(".port-connector-in"),n=[],r=0,o=t.length;o>r;r+=1){var i=t[r],c=i.parentNode.parentNode;a.hasClass(c,e)&&a.hasClass(i.nextElementSibling,"hide")&&n.push(i)}return n}function p(e){var t=e.split("/"),n=t[0],r=T[n],o=r.portMap();return o[t[1]+"/"+t[2]]}function f(e){var t=p(e);t.showConnectorConnected()}function h(e){var t=p(e);t.hideConnectorConnected()}function v(e){var t=p(e);return t.getOutConnectorElement()}function m(e){for(var t=0,n=0,r=0;e&&"main_panel"!==e.id;){var o=getComputedStyle(e,null);t=t+e.offsetLeft-parseInt(o.marginLeft||0)+parseInt(S?0:o.borderLeftWidth||0),n=n+e.offsetTop-parseInt(o.marginTop||0)+parseInt(S?0:o.borderTopWidth||0),e=e.offsetParent,r+=1}return{x:t,y:n}}function g(e){var t={},n=T[e],r=n.portMap();for(var o in r){var i=r[o],a=m(i.getOutConnectorElement());t[e+"/"+o+"/out"]={x:a.x+_,y:a.y+_};var c=m(i.getInConnectorElement());t[e+"/"+o+"/in"]={x:c.x+_-(S?0:4),y:c.y+_-(S?0:4)}}return t}function C(){return _}function y(){return 0!==o.querySelectorAll(".piece.loading").length}function x(){return P.clientWidth}function b(){i.support.touch&&(P.style.cssText="-webkit-overflow-scrolling: auto;",setTimeout(function(){P.style.cssText=""},0))}var P=null,L=null,T={},M=function(){var e=Math.floor(Math.random()*Math.pow(10,16)),t=0;return function(){var n=CryptoJS.SHA1(("0"+e+t).slice(-16)+Math.random().toString().substring(1));return t+=1,n.toString()}}(),_=21,S=-1!==navigator.userAgent.toLowerCase().indexOf("firefox");return{element:e,pageToLocal:t,append:n,remove:r,pieceMap:c,showAllPieceComponentBack:s,hideAllPieceComponentBack:l,size:u,getInConnectorNotConnectedElements:d,showPortConnectorConnected:f,hidePortConnectorConnected:h,getOutConnectorElement:v,getConnectorOffset:m,getConnectorPositionMap:g,getConnectorSizeOffset:C,isLoading:y,clientWidth:x,resetTouchScroll:b}}(),x=function(){function n(e,t){var n,r,o,i=[];if(e)for(n in e)r=e[n],o=P.create("prop",n,r.label,r["in"]===!0,r.out===!0,r["default"]===!0),i.push(o);if(t)for(n in t)r=t[n],o=P.create("event",n,r.label,r["in"]===!0,r.out===!0,r["default"]===!0),i.push(o);return i}function l(e){if("option"===e.tagName.toLowerCase())return null;for(;e;)if(e=e.parentNode,e&&"piece"===e.className){var t=y.pieceMap();return t[e.getAttribute("data-piece-id")]}return null}function u(e){var t=e.type;if("connect"===t||"disconnect"===t){var n=e.targetPortID.split("/"),r=n[0],o=n[1];if("event"===o)return;var i,a,c=n[2];if("connect"===t){var s=e.sourcePortID.split("/");i=B.get(s[0],s[2]),a=!0}else"disconnect"===t&&(i=null,a=!1);d(r,o,c,i,a)}}function d(e,t,n,r,o){var i={type:t,target:n};"prop"===t&&(i.data=r),i.isConnected=o;var a=y.pieceMap()[e];if(a){var c=a.getComponentElement();c.contentWindow.postMessage(JSON.stringify(i),"*")}}function p(e,t){var n=S(e),r=S(t),o=e+"/out",i=t+"/in";n.setFlushOutConnector(!0),r.setFlushInConnector(!0),r.setFlushConnectorConnected(!0),C.setFlushPath(o,i,!0),setTimeout(function(){n.setFlushOutConnector(!1),r.setFlushInConnector(!1),r.setFlushConnectorConnected(!1),C.setFlushPath(o,i,!1)},160)}function f(t){e.console&&"function"==typeof console.warn&&console.warn(t)}function h(e){var t=b.create(e.src);return t.position({x:e.x,y:e.y}),t.updatePosition(),y.append(t),t.id()}function v(e,t){if("drag"!==e.target){var n=e.source.split("/"),r=t[n[0]]+"/"+n[1]+"/"+n[2],o=e.target.split("/"),i=t[o[0]]+"/"+o[1]+"/"+o[2];E(r,i)}}function m(){H=!0;var t=location.hash.substring(1);if(t){try{var n=JSON.parse(r.decode(t))}catch(o){return e.console&&"function"==typeof console.error&&console.error(o),void(H=!1)}for(var i=n.node,a={},c=0,s=i.length;s>c;c+=1){var l=i[c],u=h(l);a[l.id]=u}var p=0;setTimeout(function m(){if(y.isLoading())100>p?(setTimeout(m,100),p+=1):(location.replace("index.html#"+t),f("Load time out"),H=!1);else{for(var e=n.data,r=0,o=e.length;o>r;r+=1){var i=e[r],c=a[i.id];d(c,"prop",i.target,i.data,!1)}for(var s=n.link,r=0,o=s.length;o>r;r+=1){var l=s[r];v(l,a)}C.size(y.size()),H=!1}},100)}else location.replace("index.html#"),H=!1}function x(){e.addEventListener("resize",t(function(){C.size(y.size())},1e3/60))}function L(){e.addEventListener("message",function(e){try{var t=JSON.parse(e.data)}catch(r){return}var o=t.id,i=y.pieceMap()[o];if("undefined"!=typeof i){var a=t.data,c=t.type,s=t.target;switch(c){case"load":if(!i.isLoading())return;i.label(a.label),i.componentHeight(a.componentHeight);var l=n(a.prop,a.event);i.setPorts(l),i.vitalize();var u=a.prop;for(var s in u)"data"in u[s]&&B.set(o,s,u[s].data),u[s].serialize===!0&&B.setSerializeTarget(o,s);break;case"prop":B.set(o,s,a);for(var f=C.getTargetIDs(o+"/prop/"+s+"/out"),h=0,v=f.length;v>h;h+=1){var m=f[h];if("drag"!==m){var g=m.split("/"),o=g[0],s=g[2];d(o,"prop",s,a,!0)}}break;case"event":for(var x=o+"/event/"+s,f=C.getTargetIDs(x+"/out"),h=0,v=f.length;v>h;h+=1){var m=f[h];if("drag"!==m){var g=m.split("/"),o=g[0],s=g[2];d(o,"event",s,null,!0);var b=m.replace(/\/in$/,"");p(x,b)}}}q()}},!1)}function T(e){e.addEventListener(z,function(e){var t=e.target;if(!a.hasClass(t,"loading")){var n=e.target.className.toString().split(" ")[0],r=l(t);switch(r&&(r.toFront(),r.updatePosition(),o.activeElement&&o.activeElement.blur&&o.activeElement.blur()),n){case"port-content-delete-button":F(e);break;case"piece-header-delete-button":A(e);break;case"piece-header-title":N(e);break;case"port-content-text":D(e);break;case"port-connector-out":V(e);break;case"port-connector-connected":V(e,!0)}}},!1)}function M(e){x(),L(),T(e.mainPanel)}function _(e){var t=e.target.value.split("/"),n=t[0],r=y.pieceMap()[n],o=r.portMap(),i=t[1]+"/"+t[2];r.showPort(o[i])}function S(e){var t=e.split("/"),n=t[0],r=y.pieceMap()[n],o=r.portMap(),i=t[1]+"/"+t[2];return o[i]}function E(e,t){if(null!==e&&null!==t){var n=y.pieceMap(),r=e.split("/")[0],o=t.split("/")[0],i=n[r],a=n[o],c=S(e),s=S(t);i.showPort(c),a.showPort(s),s.showConnectorConnected(),C.append(e+"/out",t+"/in"),k(r),k(o),C.updatePosition(),u({type:"connect",sourcePortID:e,targetPortID:t})}}function I(e,t){if(null!==e&&null!==t){var n=S(t);n.hideConnectorConnected(),C.remove(e,t),u({type:"disconnect",sourcePortID:e.replace(/\/out$/,""),targetPortID:t.replace(/\/in$/,"")})}}function w(e){for(var t=e+"/out",n=C.getTargetIDs(t),r=0,o=n.length;o>r;r+=1)I(t,n[r]);var i=e+"/in";I(C.getSourceID(i),i)}function A(e){var t=e.target.parentNode.parentNode.getAttribute("data-piece-id"),n=y.pieceMap()[t];O&&n.addClassOfHeader("delete"),a.startTapEvent(e,{tap:function(){y.remove(n),B.remove(t),O&&n.removeClassOfHeader("delete"),q(),C.size(y.size())},cancel:function(){O&&n.removeClassOfHeader("delete")}})}function k(e){var t=y.getConnectorPositionMap(e);for(var n in t)C.position(n,t[n])}function N(e){function t(){l&&(s(t),r.updatePosition(),C.updatePosition())}var n=e.target.parentNode.parentNode.getAttribute("data-piece-id"),r=y.pieceMap()[n],o=r.position(),i=o.x,c=o.y,l=!0;a.startDragEvent(e,{drag:function(e,t){r.position({x:i+e,y:c+t}),k(n)},end:function(e,t){y.hideAllPieceComponentBack(),C.size(y.size()),l=!1,s(function(){r.position({x:i+e,y:c+t}),r.updatePosition(),k(n),C.updatePosition(),C.refreshPosition()}),O&&r.removeClassOfHeader("drag"),q()}}),y.showAllPieceComponentBack(),s(t),O&&r.addClassOfHeader("drag")}function D(e){function t(){v&&(s(t),i.style.cssText=a.makeCSSText({top:n+"px"}),C.updatePosition())}var n,r,o,i=e.target.parentNode.parentNode,c=i.parentNode,l=i.getAttribute("data-port-id"),u=i.cloneNode(),d=a.indexOf(c,i),p=46,f=p*d,h=p*(c.children.length-1),v=!0,m=l.split("/")[0];a.startDragEvent(e,{drag:function(e,i){v&&s(t);var a=f+i;0>a&&(a=0),a>h&&(a=h),n=a;var l=parseInt((n-f)/p+(i>0?.5:-.5)),g=d+l+(l>=0?1:0);o!==g&&(c.insertBefore(u,r[g]||null),o=g),k(m)},end:function(e,t){y.hideAllPieceComponentBack(),v=!1,s(function(){i.style.cssText="",c.insertBefore(i,u),a.removeClass(i,"drag"),c.removeChild(u),k(m),C.updatePosition(),C.refreshPosition()})}}),y.showAllPieceComponentBack(),a.addClass(u,"placeholder"),a.addClass(i,"drag"),c.insertBefore(u,i.nextSibling),r=c.querySelectorAll(".port:not(.drag)")}var O=i.support.touch,z=a.eventType.START,H=!1,B=function(){function e(e,t,n){e in i||(i[e]={}),i[e][t]=n}function t(e,t){return e in i&&t in i[e]?i[e][t]:null}function n(e){delete i[e],delete a[e]}function r(e,t){e in a||(a[e]=[]),a[e].push(t)}function o(){var e=[];for(var t in a)for(var n=a[t],r=0,o=n.length;o>r;r+=1)e.push({pieceID:t,target:n[r],data:i[t][n[r]]});return e}var i={},a={};return{set:e,get:t,remove:n,setSerializeTarget:r,serialize:o}}(),q=function(){function e(e,t){var n=e.sourceID.split("/"),r=e.targetID.split("/");return{source:t[n[0]]+"/"+n[1]+"/"+n[2],target:t[r[0]]+"/"+r[1]+"/"+r[2]}}return t(function(){if(!H){var t=y.pieceMap(),n={},o=0,i=[];for(var a in t){var c=t[a].getAttribute();c.id=o,n[a]=o,i[o]=c,o+=1}for(var s=C.getConnectionList(),l=0,u=s.length;u>l;l+=1)s[l]=e(s[l],n);for(var d=B.serialize(),l=0,u=d.length;u>l;l+=1){var a=d[l].pieceID;d[l].id=n[a],delete d[l].pieceID}var p="";i.length>0&&(p=r.encodeURI(JSON.stringify({node:i,link:s,data:d}))),location.replace("index.html#"+p);var h=location.href.length;h>2083&&f("Too long URL("+h+" words)")}},100)}(),F=function(){function e(e){var t=e.target.parentNode.parentNode.getAttribute("data-port-id"),n=t.split("/"),r=n[0],o=y.pieceMap()[r],i=o.portMap(),a=n[1]+"/"+n[2];o.hidePort(i[a]),w(t),k(r),C.updatePosition(),C.refreshPosition()}return function(t){a.startTapEvent(t,{tap:function(){e(t)}})}}(),V=function(){function e(e){for(var t=y.getInConnectorNotConnectedElements(e),n={},r=0,o=t.length;o>r;r+=1){var i=t[r],a=i.parentNode.parentNode.getAttribute("data-port-id"),c=d(t[r]);c.x+=l-(p?0:4),c.y+=l-(p?0:4),n[a]=c}return n}function t(e){var t={};for(var n in e){var r=e[n],o=r.x,i=r.y;o in t||(t[o]={}),t[o][i]=n}return t}function n(e){return e>0?e:-e}function r(e,t){var r=t.x,o=t.y;for(var i in e)if(n(r-i)<l){var a=e[i];for(var c in a)if(n(o-c)<l)return{portID:a[c],point:{x:i,y:c}}}return null}function o(e){return a.hasClass(e,"prop")?"prop":a.hasClass(e,"event")?"event":void 0}var i=a.hasClass,l=y.getConnectorSizeOffset(),d=y.getConnectorOffset,p=-1!==navigator.userAgent.toLowerCase().indexOf("firefox");return function(n,p){function f(){D&&(g.update(),C.updatePosition())}function h(){g.position(L),g.update(),i(T,"prop")?g.type("prop"):i(T,"event")&&g.type("event")}var v,m=n.target;if(p){var x=m.parentNode.parentNode.getAttribute("data-port-id"),b=C.getSourceID(x+"/in"),P=y.getOutConnectorElement(b.replace(/\/out/,""));v=P}else v=m;if(!i(v,"drag")){var L=d(v),T=v.parentNode.parentNode,x=T.getAttribute("data-port-id"),M={x:L.x+l,y:L.y+l},_=d(m),E={x:_.x+l,y:_.y+l},I=e(o(T));if(p){var w=m.parentNode.parentNode.getAttribute("data-port-id");I[w]=E}var A,k,N=t(I),D=!0;a.startDragEvent(n,{drag:function(e,t){D&&s(f),g.position({x:_.x+e,y:_.y+t});var n={x:E.x+e,y:E.y+t},o=r(N,n),i=k.replace(/\/in$/,"");if(null!==o){var a=o.portID+"/in";if(a!==k){var c=k;if(C.change([A,k],[A,a]),k=a,C.position(a,o.point),g.hide(),y.showPortConnectorConnected(o.portID),"drag"!==i){y.hidePortConnectorConnected(i);var l=c.replace(/\/in$/,"");u({type:"disconnect",sourcePortID:A.replace(/\/out$/,""),targetPortID:l}),O&&S(l).clearMark()}var d=k.replace(/\/in$/,"");u({type:"connect",sourcePortID:A.replace(/\/out$/,""),targetPortID:d}),O&&S(d).mark()}}else{var a="drag";if(a!==k){var c=k;C.change([A,k],[A,a]),k=a,"drag"!==i&&y.hidePortConnectorConnected(i),g.show();var l=c.replace(/\/in$/,"");u({type:"disconnect",sourcePortID:A.replace(/\/out$/,""),targetPortID:l}),O&&S(l).clearMark()}C.position(a,n)}},end:function(e,t){if(y.hideAllPieceComponentBack(),D=!1,s(function(){g.hide(),g.position({x:2*-l,y:2*-l}),g.update(),C.remove(A,"drag"),C.refreshPosition(),c.type("default")}),O&&(S(x).clearMark(),"drag"!==k)){var n=k.replace(/\/in$/,"");S(n).clearMark()}q()}}),y.showAllPieceComponentBack(),h(),A=x+"/out",p?(k=w+"/in",g.hide()):(k="drag",g.show()),C.append(A,k),C.position(A,M),C.position(k,E),C.updatePosition(),O&&s(function(){S(x).mark(),p&&S(w).mark()}),c.type("crosshair")}}}();return{element:M,showPort:_,removePortConnection:w,loadURLHash:m}}(),b=function(){function e(e){var t=Object.create(this),n=u.createPiece(e);return t._elementMap=n,M+=1,t._zIndex=M,n.portSelect.addEventListener("change",x.showPort,!1),t._src=e,t._isLoading=!0,t}function t(){this._elementMap.portSelect.removeEventListener("change",x.showPort,!1);var e=this._id,t=this._portMap;for(var n in t)x.removePortConnection(e+"/"+n)}function n(){var e=this._elementMap;S(e.element,"loading"),S(e.headerTitle,"loading"),S(e.content,"loading"),S(e.portList,"hide"),S(e.footer,"loading"),this.updatePosition(),this._isLoading=!1}function r(e){return e?(this._id=e,this._elementMap.element.setAttribute("data-piece-id",e),void this._elementMap.component.setAttribute("src",this._src+"#"+e)):this._id}function i(e){e&&(this._elementMap.headerTitle.textContent=e)}function c(e){return e?("x"in e&&(this._x=Math.max(e.x,0)),void("y"in e&&(this._y=Math.max(e.y,0)))):{x:this._x,y:this._y}}function s(e){if(e){var t=this._elementMap;t.component.style.height=e,t.componentBack.style.height=e,0===parseInt(e)&&(_(t.component,"hide"),_(t.portList,"no-component"))}}function l(){this._x=Math.max(this._x,this._isShowingInConnector?46:0);var e=a.makeCSSText({left:this._x+"px",top:this._y+"px","z-index":this._zIndex});this._elementMap.element.style.cssText=e}function d(){return this._elementMap.element}function p(e){for(var t=this._id,n={},r=0,o=e.length;o>r;r+=1){var i=e[r],a=i.type()+"/"+i.key(),c=t+"/"+a;i.id(c),i.isDefault()?this.showPort(i):this.hidePort(i),n[a]=i}this._portMap=n}function f(e){var t=e.element(),n=this._elementMap,r=n.portList;if(!r.contains(t)){r.appendChild(t);for(var o=n.portSelectOptionGroup[e.type()],i=o.children,a=i.length-1;a>=0;a-=1){var c=i[a];c.value===e.id()&&o.removeChild(c)}var s=n.portSelect;1===s.options.length&&_(s,"hide"),s.value="",s.blur();var r=n.portList;this._isShowingInConnector=r.querySelectorAll(".port-connector-in").length!==r.querySelectorAll(".port-connector-in.hide").length,this.updatePosition()}}function h(e){var t=e.element(),n=this._elementMap,r=n.portList;r.contains(t)&&r.removeChild(t);var i=o.createElement("option");i.value=e.id(),i.textContent=e.contentText();var a,c,s=n.portSelectOptionGroup[e.type()],l=s.children,u=[];for(a=0,c=l.length;c>a;a+=1)u.push(l[a]);for(u.push(i),u.sort(function(e,t){return e.textContent>t.textContent?1:-1}),a=0,c=u.length;c>a;a+=1){var d=u[a];s.appendChild(d)}var p=n.portSelect;1!==p.options.length&&S(p,"hide"),p.value="",p.blur(),this._isShowingInConnector=r.querySelectorAll(".port-connector-in").length!==r.querySelectorAll(".port-connector-in.hide").length,this.updatePosition()}function v(){return this._portMap}function m(){S(this._elementMap.componentBack,"hide")}function g(){_(this._elementMap.componentBack,"hide")}function C(){M+=1,this._zIndex=M}function y(e){_(this._elementMap.header,e)}function b(e){S(this._elementMap.header,e)}function P(){return{id:this._id,src:this._src,x:this._x,y:this._y}}function L(){return this._isLoading}function T(){return this._elementMap.component}var M=0,_=a.addClass,S=a.removeClass;return{create:e,destroy:t,vitalize:n,id:r,label:i,position:c,componentHeight:s,updatePosition:l,element:d,setPorts:p,showPort:f,hidePort:h,portMap:v,showComponentBack:m,hideComponentBack:g,toFront:C,addClassOfHeader:y,removeClassOfHeader:b,getAttribute:P,isLoading:L,getComponentElement:T}}(),P=function(){function e(e,t,n,r,o,i){var a=Object.create(this),c=u.createPort(e,n,r,o);return a._elementMap=c,a._type=e,a._key=t,a._isDefault=i,a._contentText=n,C(c.connectorConnected,"hide"),a}function t(e){return e?(this._id=e,void this._elementMap.element.setAttribute("data-port-id",e)):this._id}function n(){return this._type}function r(){return this._key}function o(){return this._elementMap.element}function i(){return this._isDefault}function c(){return this._contentText}function s(){y(this._elementMap.connectorConnected,"hide")}function l(){C(this._elementMap.connectorConnected,"hide")}function d(){return this._elementMap.connectorOut}function p(){return this._elementMap.connectorIn}function f(e){e?C(this._elementMap.connectorIn,"flush"):y(this._elementMap.connectorIn,"flush")}function h(e){e?C(this._elementMap.connectorConnected,"flush"):y(this._elementMap.connectorConnected,"flush")}function v(e){e?C(this._elementMap.connectorOut,"flush"):y(this._elementMap.connectorOut,"flush")}function m(){C(this._elementMap.element,"mark")}function g(){y(this._elementMap.element,"mark")}var C=a.addClass,y=a.removeClass;return{create:e,id:t,type:n,
key:r,element:o,isDefault:i,contentText:c,showConnectorConnected:s,hideConnectorConnected:l,getOutConnectorElement:d,getInConnectorElement:p,setFlushInConnector:f,setFlushConnectorConnected:h,setFlushOutConnector:v,mark:m,clearMark:g}}();n()}(this);